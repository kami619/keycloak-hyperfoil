name: keycloak-poc
http:
  host: http://localhost:8080
  sharedConnections: 100
phases:
- steadyState:
    constantRate:
      startAfter: rampUp
      usersPerSec: 0.3
      duration: 1m
      maxSessions: 2
      scenario: &loginUsernamePassword
          - openLandingPage:
            - randomUUID:
                toVar: uuid
            - set: scope <- openid profile
            - set: redirectUri <- localhost:8080/auth/realms/realm-0/account/
            - httpRequest:
                GET: /auth/realms/realm-0/protocol/openid-connect/auth?login=true&response_type=code&client_id=client-0&state=${uuid}&redirect_uri=${redirectUri}&scope=${scope}
                headers: &uiHeaders
                  Accept : text/html,application/xhtml+xml,application/xml
                  Accept-Encoding : gzip, deflate
                  Accept-Language : en-US,en;q=0.5
                  User-Agent : Mozilla/5.0 (Macintosh; Intel Mac OS X 10.8; rv:16.0) Gecko/20100101 Firefox/16.0
                handler:
                  status:
                    range: 200
                  body:
                    parseHtml:
                      onTagAttribute:
                        tag: FORM
                        attribute: action
                        toVar: login-form-uri
            #- thinkTime: 5s
            # - log: #debug log
            #     message: 'Login Form URI after clean up is ${replace/&amp;/\&/g:login-form-uri}'
          - submitLogin:
            - httpRequest:
                POST: ${replace/&amp;/\&/g:login-form-uri}
                body:
                  form:
                  - name: username
                    value: "user-0"
                  - name: password
                    value: "user-0-password"
                  - name: login
                    pattern: "Log in"
                headers: *uiHeaders
                handler:
                  status:
                    range: 302
            #- thinkTime: 5s
          - logout:
            - httpRequest:
                GET: /auth/realms/realm-0/protocol/openid-connect/logout?redirect_uri=${redirectUri}
                headers: *uiHeaders
                handler:
                  status:
                    range: 302

- smokeTest:
    atOnce:
      users: 1
      scenario: *loginUsernamePassword
      
- rampUp:
    increasingRate:
      startAfter: smokeTest
      initialUsersPerSec: 0.1
      targetUsersPerSec: 0.3
      duration: 30s
      scenario: *loginUsernamePassword
- rampDown:
    decreasingRate:
      startAfter: steadyState
      initialUsersPerSec: 0.2
      targetUsersPerSec: 0.1
      duration: 30s
      scenario: *loginUsernamePassword